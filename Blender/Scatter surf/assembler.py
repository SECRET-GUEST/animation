#         ████████     ██████
#        █░░░░░░░░██_██░░░░░░█
#       █░░░░░░░░░░░█░░░░░░░░░█
#      █░░░░░░░███░░░█░░░░░░░░░█
#      █░░░░███░░░███░█░░░████░█
#    █░░░██░░░░░░░░███░██░░░░██
#   █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#   █░░░░░░░░░░░░░██████░░░░░████░░█
#   █░░░░░░░░░█████░░░████░░██░░██░░█
#  ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
# █░░░░░░░░░░░░░░█████████░░█████████
#█░░░░░░░░░░█████ ████   ████ █████ █
#█░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
#/            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#       \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |
                

#     |               |                                 |
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  |                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    |
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |
                
#                 |                     |
#  |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#          |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#  |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#               |                             /                 \                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
                
#       |                                This script allows Blender to 
                
#                                 randomly generate objects from selected              |                                           |               |                                           |               |                                           |                    |                                           |
                
#                          /                      |    v    |                    \
#                  objects on a selected objects (like for example needles on a character) 
#                                  |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |
#                                                                                                   |                                                                 |                      |                     |                       |                      |                     |                       |                      |                     |                            |
#          
#     |                  !      |                                   |     |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
#                               |                                   |     |                  
#                  |            |                   Anyway          !                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |
                
#             |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |
                

#                |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |
                
#                                                        =)
                
#
#                               |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |
                

#             |                              |       DIE ! ! !        |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#     |                        |                                         |                                |
                
#
#                                                    !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |
                
#     |               |                                 !
                
#                 |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#          |                                  !                                     |
                
#                 |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#  |                          |                       |                    !
#          |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#     |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
                
#                     |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#          |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |
                
#                 |                     |
#  |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |                                    |                       |                              |                                                                        |
#          |                               |                                         !                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|

#You don't have to import with pip, just paste the code in blender     
          
import bpy,bmesh,random, bisect, math
from mathutils import Vector
from mathutils.bvhtree import BVHTree

#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |
                

#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3

def create_collection(name, parent_collection=None):
    new_collection = bpy.data.collections.new(name)
    if parent_collection:
        parent_collection.children.link(new_collection)
    else:
        bpy.context.scene.collection.children.link(new_collection)
    return new_collection




def merge_objects_in_collection(target_collection, collection_name, new_object_name):
    collection = bpy.data.collections[collection_name]
    mesh = bpy.data.meshes.new(new_object_name)
    obj = bpy.data.objects.new(new_object_name, mesh)

    # Utiliser la collection cible pour lier les objets
    target_collection.objects.link(obj)

    bm = bmesh.new()

    for obj_to_merge in collection.objects:
        if obj_to_merge.type == 'MESH':
            mesh_to_merge = obj_to_merge.data
            transform = obj_to_merge.matrix_world
            bmesh.ops.transform(bm, verts=bm.verts, matrix=transform)
            bm.from_mesh(mesh_to_merge)

    bm.to_mesh(mesh)
    bm.free()

    return obj





def create_mech_part(collection, part_name, location, rotation):
    if part_name in bpy.data.collections:
        # Passer la collection cible à merge_objects_in_collection
        collection_object = merge_objects_in_collection(collection, part_name, f"{part_name}_object")
        part_template = collection_object
    else:
        part_template = bpy.data.objects[part_name]
    
    part = part_template.copy()
    part.data = part_template.data.copy()
    part.location = location
    part.rotation_euler = rotation
    
    # Ajouter la pièce à la collection donnée
    collection.objects.link(part)
    
    return part



def get_character_bvh_tree(character):
    depsgraph = bpy.context.evaluated_depsgraph_get()
    bm = bmesh.new()
    bm.from_object(character, depsgraph)
    bm.transform(character.matrix_world)
    return BVHTree.FromBMesh(bm)




def get_surface_point(character, bvh_tree):
    depsgraph = bpy.context.evaluated_depsgraph_get()
    mesh = character.evaluated_get(depsgraph).to_mesh()

    # Créer une liste des aires cumulées des faces
    areas_cumulative = [0]
    for face in mesh.polygons:
        areas_cumulative.append(areas_cumulative[-1] + face.area)

    # Choisir une face aléatoire en tenant compte de l'aire
    random_area = random.uniform(0, areas_cumulative[-1])
    random_face_index = bisect.bisect(areas_cumulative, random_area) - 1
    random_face = mesh.polygons[random_face_index]

    # Choisir un point aléatoire sur la face
    verts = [mesh.vertices[v].co for v in random_face.vertices]
    u, v = random.random(), random.random()
    if u + v > 1:
        u, v = 1 - u, 1 - v
    point_on_face = (1 - u - v) * verts[0] + u * verts[1] + v * verts[2]

    # Convertir le point en coordonnées mondiales
    surface_point = character.matrix_world @ point_on_face

    # Ne pas oublier de libérer le maillage
    character.to_mesh_clear()

    return surface_point





def generate_mech_parts(character, part_names, num_parts, use_symmetry):
    character_bvh_tree = get_character_bvh_tree(character)
    mech_parts = []
    
    # Créer une nouvelle collection pour les pièces générées
    new_parts_collection = create_collection("Generated_Mech_Parts")
    for _ in range(num_parts // 2 if use_symmetry else num_parts):
        location = get_surface_point(character, character_bvh_tree)
        rotation = Vector([random.uniform(0, math.pi) for _ in range(3)])
        part_name = random.choice(part_names)
        part = create_mech_part(new_parts_collection, part_name, location, rotation)
        mech_parts.append(part)

        if use_symmetry:
            mirrored_location = location * Vector([-1, 1, 1])
            mirrored_rotation = Vector([rotation[0], -rotation[1], -rotation[2]])
            mirrored_part = create_mech_part(new_parts_collection, part_name, mirrored_location, mirrored_rotation)
            mech_parts.append(mirrored_part)

    return mech_parts


character = bpy.data.objects['p2']
part_names = ('1', 'Cable', 'wire')
num_parts = 5
use_symmetry = True
mech_parts = generate_mech_parts(character, part_names, num_parts, use_symmetry)